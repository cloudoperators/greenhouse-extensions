apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-development
spec:
  replicas: 3
  selector:
    matchLabels:
      app: api-development
  template:
    metadata:
      labels:
        app: api-development
    spec:
      containers:
      - name: api
        image: sanjeevkt720/prometheus-demo
        resources:
          limits:
            memory: "128Mi"
            cpu: "500m"
        ports:
          - containerPort: 3000
---
apiVersion: v1
kind: Service
metadata:
  name: api-service
  labels: 
    app: api-development-service
    my-custom-job-label: node-api
spec:
  selector:
    app: api-development
  ports:
  - port: 3000
    targetPort: 3000
    name: web
    protocol: TCP
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: api-service-monitor
  labels:
    app: prometheus
    release: prometheus # this label is required as the Prometheus Operator uses it to discover ServiceMonitors
spec:
  jobLabel: my-custom-job-label # This label matches the key of the label in the target service.
  endpoints:
    - interval: 30s
      port: web
      path: /swagger-stats/metrics
  selector:
    matchLabels:
      app: api-development-service
    
--- 
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: api-prometheus-rule
  labels:
    app: prometheus
    release: prometheus
spec:
  groups:
    - name: api
      rules:
        - alert: down
          expr: up == 0
          for: 0m
          labels:
            severity: critical
          annotations:
            summary: "Prometheus target missing {{ $labels.instance }}"
--- 
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: alertmanager-config
  labels:
    app: prometheus
    role: example-config # should match the alertmanager.spec.alertmanagerConfigSelector.matchLabels
spec:
  route:
    groupBy: ["severity"]
    groupWait: 30s
    groupInterval: 5m
    repeatInterval: 12h
    receiver: "webhook"
  receivers:
    - name: "webhook"
      webhookConfigs:
        - url: "http://example.com/webhook"

