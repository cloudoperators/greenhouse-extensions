{{- if .Values.networkPolicies }}
{{- range $idx, $policy := .Values.networkPolicies }}
{{- if $policy.enabled }}
---
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "kube-prometheus-stack.fullname" $ }}{{ if $policy.nameSuffix }}-{{ $policy.nameSuffix }}{{ else if gt (len $.Values.networkPolicies) 1 }}-{{ $idx }}{{ end }}
  namespace: {{ $policy.namespace | default $.Release.Namespace }}
  labels:
    {{- include "kube-prometheus-stack.labels" $ | indent 4 }}
    {{- with $policy.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with $policy.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  podSelector:
    {{- if $policy.podSelector }}
    {{- toYaml $policy.podSelector | nindent 4 }}
    {{- else }}
    matchLabels:
      plugin: {{ $.Release.Name }}
    {{- end }}
  policyTypes:
    {{- if $policy.policyTypes }}
    {{- toYaml $policy.policyTypes | nindent 4 }}
    {{- else }}
    - Ingress
    - Egress
    {{- end }}
  {{- if $policy.ingress }}
  ingress:
    {{- toYaml $policy.ingress | nindent 4 }}
  {{- end }}
  {{- if $policy.egress }}
  egress:
    {{- toYaml $policy.egress | nindent 4 }}
  {{- end }}
{{- end }}
{{- end }}
{{- end }}
