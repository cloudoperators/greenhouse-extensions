# All alert severities are set to 'info' for setup only. Original severity is preserved as a comment on each line.
groups:
  - name: opensearch-cluster-siem
    interval: 30s
    rules:
      - alert: OpenSearchSIEMClusterRed
        expr: opensearch_cluster_status{cluster=~".*siem.*"} == 2
        for: 5m
        labels:
          severity: info # critical
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchClusterRed.md
          {{- include "opensearch-alert-labels" . | nindent 10 }}
        annotations:
          summary: "OpenSearch SIEM cluster status is RED"
          description: "OpenSearch SIEM cluster {{`{{ $labels.cluster }}`}} is in RED status for more than 5 minutes"

      - alert: OpenSearchSIEMClusterYellow
        expr: opensearch_cluster_status{cluster=~".*siem.*"} == 1
        for: 20m
        labels:
          severity: info # warning
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchClusterYellow.md
          {{- include "opensearch-alert-labels" . | nindent 10 }}
        annotations:
          summary: "OpenSearch SIEM cluster status is YELLOW"
          description: "OpenSearch SIEM cluster {{`{{ $labels.cluster }}`}} is in YELLOW status for more than 20 minutes"

      - alert: OpenSearchSIEMNodeDown
        expr: up{job=~".*siem.*opensearch.*"} == 0
        for: 10m
        labels:
          severity: info # critical
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchNodeDown.md
          {{- include "opensearch-alert-labels" . | nindent 10 }}
        annotations:
          summary: "OpenSearch SIEM node is down"
          description: "OpenSearch SIEM node {{`{{ $labels.instance }}`}} has been down for more than 10 minutes"

      - alert: OpenSearchSIEMHighMemoryUsage
        expr: (opensearch_jvm_mem_heap_used_bytes{cluster=~".*siem.*"} / opensearch_jvm_mem_heap_max_bytes{cluster=~".*siem.*"}) * 100 > 95
        for: 15m
        labels:
          severity: info # warning
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchHighMemoryUsage.md
          {{- include "opensearch-alert-labels" . | nindent 10 }}
        annotations:
          summary: "High JVM heap memory usage in SIEM cluster"
          description: "OpenSearch SIEM node {{`{{ $labels.instance }}`}} heap memory usage is above 95% ({{`{{ $value }}`}}%)"

      - alert: OpenSearchSIEMHighCPUUsage
        # Improved: Use opensearch_process_cpu_percent for direct CPU usage percentage
        expr: opensearch_process_cpu_percent{cluster_segment=~".*siem.*"} > 95
        for: 20m
        labels:
          severity: info # warning
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchHighCPUUsage.md
          {{- include "opensearch-alert-labels" . | nindent 10 }}
        annotations:
          summary: "High CPU usage in SIEM cluster"
          description: "OpenSearch SIEM node {{`{{ $labels.instance }}`}} CPU usage is above 95% ({{`{{ $value }}`}}%)"

      - alert: OpenSearchSIEMHighDiskUsage
        expr: 100 * (1 - (opensearch_fs_total_free_bytes{cluster=~".*siem.*"} / opensearch_fs_total_total_bytes{cluster=~".*siem.*"})) > 90
        for: 10m
        labels:
          severity: info # warning
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchHighDiskUsage.md
          {{- include "opensearch-alert-labels" . | nindent 10 }}
        annotations:
          summary: "High disk usage in SIEM cluster"
          description: "OpenSearch SIEM node {{`{{ $labels.instance }}`}} disk usage is above 90% ({{`{{ $value }}`}}%)"

      - alert: OpenSearchSIEMIndexSizeTooLarge
        expr: max by (index) (opensearch_index_store_size_bytes{cluster=~".*siem.*",context="primaries"} / (1024^3) > 200)
        for: 30m
        labels:
          severity: info # warning
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchIndexTooLarge.md
          {{- include "opensearch-alert-labels" . | nindent 10 }}
        annotations:
          description: "The SIEM index {{`{{ $labels.index }}`}} has exceeded 200 GB in size. Please check the rollover status."
          summary: "SIEM index size of {{`{{ $labels.index }}`}} has exceeded the threshold."
