# All alert severities are set to 'info' for setup only. Original severity is preserved as a comment on each line.
groups:
  - name: opensearch-operator
    interval: 30s
    rules:
      - alert: OpenSearchOperatorDown
        expr: up{job=~".*opensearch-operator.*"} == 0
        for: 10m
        labels:
          severity: info # critical
          component: opensearch-operator
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchOperatorDown.md
          {{ tpl .Values.cluster.cluster.general.monitoring.additionalRuleLabels $ | nindent 10 }}
        annotations:
          summary: "OpenSearch operator is down"
          description: "OpenSearch operator in namespace {{`{{ $labels.namespace }}`}} has been down for more than 10 minutes"

      - alert: OpenSearchOperatorRestarts
        expr: increase(kube_pod_container_status_restarts_total{container="operator-controller-manager", namespace="{{ .Release.Namespace }}"}[1h]) > 20
        for: 10m
        labels:
          severity: info # warning
          component: opensearch-operator
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchOperatorRestarts.md
          {{ tpl .Values.cluster.cluster.general.monitoring.additionalRuleLabels $ | nindent 10 }}
        annotations:
          summary: "OpenSearch operator restarting frequently"
          description: "OpenSearch operator pod {{`{{ $labels.pod }}`}} has restarted {{`{{ $value }}`}} times in the last hour"

      - alert: OpenSearchOperatorReconcileErrors
        expr: increase(controller_runtime_reconcile_errors_total{controller="opensearchcluster"}[10m]) > 10
        for: 10m
        labels:
          severity: info # warning
          component: opensearch-operator
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchOperatorReconcileErrors.md
          {{ tpl .Values.cluster.cluster.general.monitoring.additionalRuleLabels $ | nindent 10 }}
        annotations:
          summary: "OpenSearch operator reconcile errors"
          description: "OpenSearch operator controller {{`{{ $labels.controller }}`}} has {{`{{ $value }}`}} reconcile errors in the last 10 minutes"

      - alert: OpenSearchOperatorHighReconcileTime
        expr: histogram_quantile(0.95, rate(controller_runtime_reconcile_time_seconds_bucket{controller="opensearchcluster"}[10m])) > 60
        for: 10m
        labels:
          severity: info # warning
          component: opensearch-operator
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchOperatorHighReconcileTime.md
          {{ tpl .Values.cluster.cluster.general.monitoring.additionalRuleLabels $ | nindent 10 }}
        annotations:
          summary: "High operator reconcile time"
          description: "OpenSearch operator 95th percentile reconcile time is above 60s ({{`{{ $value }}`}}s)"

      - alert: OpenSearchOperatorHighMemoryUsage
        expr: (container_memory_working_set_bytes{container="operator-controller-manager", namespace="{{ .Release.Namespace }}"} / container_spec_memory_limit_bytes{container="operator-controller-manager", namespace="{{ .Release.Namespace }}"}) * 100 > 95
        for: 15m
        labels:
          severity: info # warning
          component: opensearch-operator
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchOperatorHighMemoryUsage.md
          {{ tpl .Values.cluster.cluster.general.monitoring.additionalRuleLabels $ | nindent 10 }}
        annotations:
          summary: "High operator memory usage"
          description: "OpenSearch operator memory usage is above 95% ({{`{{ $value }}`}}%)"

      - alert: OpenSearchOperatorHighCPUUsage
        expr: (rate(container_cpu_usage_seconds_total{container="operator-controller-manager", namespace="{{ .Release.Namespace }}"}[5m]) / container_spec_cpu_quota{container="operator-controller-manager", namespace="{{ .Release.Namespace }}"} * container_spec_cpu_period{container="operator-controller-manager", namespace="{{ .Release.Namespace }}"}) * 100 > 95
        for: 20m
        labels:
          severity: info # warning
          component: opensearch-operator
          playbook: https://github.com/cloudoperators/greenhouse-extensions/tree/main/opensearch/playbooks/OpenSearchOperatorHighCPUUsage.md
          {{ tpl .Values.cluster.cluster.general.monitoring.additionalRuleLabels $ | nindent 10 }}
        annotations:
          summary: "High operator CPU usage"
          description: "OpenSearch operator CPU usage is above 95% ({{`{{ $value }}`}}%)"
