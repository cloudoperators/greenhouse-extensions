{{- if .Values.testFramework.enabled -}}
# SPDX-FileCopyrightText: 2024 SAP SE or an SAP affiliate company and Greenhouse contributors
# SPDX-License-Identifier: Apache-2.0
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-test
  namespace: {{ .Release.Namespace }}
  labels:
    type: integration-test
    {{- include "opensearch.labels" . | nindent 4 }}
data:
  run.sh: |-

    #!/usr/bin/env bats

    load "/usr/lib/bats/bats-detik/utils"
    load "/usr/lib/bats/bats-detik/detik"

    DETIK_CLIENT_NAME="kubectl"
    DETIK_CLIENT_NAMESPACE="{{ .Release.Namespace }}"

    @test "Verify successful deployment and running status of the operator pod" {
        try "at most 5 times every 5s to get pods named '{{ .Release.Name }}-operator-controller-manager-[a-z0-9]+-[a-z0-9]+' and verify that '.status.phase' is 'Running'"
    }

    @test "Verify successful deployment of the operator service" {
        verify "there is 1 service named '{{ .Release.Name }}-operator-controller-manager-metrics-service$'"
    }

    @test "Verify presence of OpenSearchCluster resource" {
      [ "$(kubectl get opensearchclusters.opensearch.opster.io -n {{ .Release.Namespace }} --no-headers | wc -l)" -ge 1 ]
    }

    @test "Verify presence of OpenSearchIndexTemplate resource" {
      [ "$(kubectl get opensearchindextemplates.opensearch.opster.io -n {{ .Release.Namespace }} --no-headers | wc -l)" -ge 1 ]
    }

    @test "Verify presence of OpenSearchRole resource" {
      [ "$(kubectl get opensearchroles.opensearch.opster.io -n {{ .Release.Namespace }} --no-headers | wc -l)" -ge 1 ]
    }

    @test "Verify presence of OpenSearchUser resource" {
      [ "$(kubectl get opensearchusers.opensearch.opster.io -n {{ .Release.Namespace }} --no-headers | wc -l)" -ge 1 ]
    }

    @test "Verify presence of OpenSearchUserRoleBinding resource" {
      [ "$(kubectl get opensearchuserrolebindings.opensearch.opster.io -n {{ .Release.Namespace }} --no-headers | wc -l)" -ge 1 ]
    }

    @test "Verify presence of OpenSearchISMPolicy resource" {
      [ "$(kubectl get opensearchismpolicies.opensearch.opster.io -n {{ .Release.Namespace }} --no-headers | wc -l)" -ge 1 ]
    }

    @test "Verify presence of OpenSearchComponentTemplate resource" {
      [ "$(kubectl get opensearchcomponenttemplates.opensearch.opster.io -n {{ .Release.Namespace }} --no-headers | wc -l)" -ge 1 ]
    }

    @test "Verify presence of OpenSearchTenant resource" {
      [ "$(kubectl get opensearchtenants.opensearch.opster.io -n {{ .Release.Namespace }} --no-headers | wc -l)" -ge 0 ]
    }

    # ===== OpenSearch logs Cluster Tests =====

    @test "Verify OpenSearch logs main pod is running" {
        try "at most 20 times every 15s to get pods named '{{ .Values.cluster.cluster.name }}-main-' and verify that '.status.phase' is 'Running'"
    }

    @test "Verify OpenSearch logs data pod is running" {
        try "at most 20 times every 15s to get pods named '{{ .Values.cluster.cluster.name }}-data-' and verify that '.status.phase' is 'Running'"
    }

    @test "Verify OpenSearch logs client pod is running" {
        try "at most 20 times every 15s to get pods named '{{ .Values.cluster.cluster.name }}-client-' and verify that '.status.phase' is 'Running'"
    }

    # The dashboards pod will not be scheduled if the ServiceMonitor CRD is missing. If the following test fails, please ensure the ServiceMonitor CRD is installed (e.g. via the kube-monitoring plugin).
    @test "Verify OpenSearch logs dashboards pod is running" {
        try "at most 24 times every 15s to get pods named '{{ .Values.cluster.cluster.name }}-dashboards-' and verify that '.status.phase' is 'Running'"
    }

    @test "Verify OpenSearch logs main service exists" {
        try "at most 5 times every 5s to get services named '{{ .Values.cluster.cluster.name }}-main' and verify that '.metadata.name' is '{{ .Values.cluster.cluster.name }}-main'"
    }

    @test "Verify OpenSearch logs data service exists" {
        try "at most 5 times every 5s to get services named '{{ .Values.cluster.cluster.name }}-data' and verify that '.metadata.name' is '{{ .Values.cluster.cluster.name }}-data'"
    }

    @test "Verify OpenSearch logs client service exists" {
        try "at most 5 times every 5s to get services named '{{ .Values.cluster.cluster.name }}-client' and verify that '.metadata.name' is '{{ .Values.cluster.cluster.name }}-client'"
    }

{{- if .Values.siem.enabled }}
    # ===== OpenSearch siem Cluster Tests =====

    @test "Verify OpenSearch siem main pod is running" {
        try "at most 20 times every 15s to get pods named '{{ .Values.siem.cluster.name }}-main-' and verify that '.status.phase' is 'Running'"
    }

    @test "Verify OpenSearch siem data pod is running" {
        try "at most 20 times every 15s to get pods named '{{ .Values.siem.cluster.name }}-data-' and verify that '.status.phase' is 'Running'"
    }

    @test "Verify OpenSearch siem client pod is running" {
        try "at most 20 times every 15s to get pods named '{{ .Values.siem.cluster.name }}-client-' and verify that '.status.phase' is 'Running'"
    }

    @test "Verify OpenSearch siem dashboards pod is running" {
        try "at most 24 times every 15s to get pods named '{{ .Values.siem.cluster.name }}-dashboards-' and verify that '.status.phase' is 'Running'"
    }

    @test "Verify OpenSearch siem main service exists" {
        try "at most 5 times every 5s to get services named '{{ .Values.siem.cluster.name }}-main' and verify that '.metadata.name' is '{{ .Values.siem.cluster.name }}-main'"
    }

    @test "Verify OpenSearch siem data service exists" {
        try "at most 5 times every 5s to get services named '{{ .Values.siem.cluster.name }}-data' and verify that '.metadata.name' is '{{ .Values.siem.cluster.name }}-data'"
    }

    @test "Verify OpenSearch siem client service exists" {
        try "at most 5 times every 5s to get services named '{{ .Values.siem.cluster.name }}-client' and verify that '.metadata.name' is '{{ .Values.siem.cluster.name }}-client'"
    }
{{- end }}

{{- end -}}
