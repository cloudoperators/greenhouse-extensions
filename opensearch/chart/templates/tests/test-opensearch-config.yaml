{{- if .Values.testFramework.enabled -}}
# SPDX-FileCopyrightText: 2024 SAP SE or an SAP affiliate company and Greenhouse contributors
# SPDX-License-Identifier: Apache-2.0
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-test
  namespace: {{ .Release.Namespace }}
  labels:
    type: integration-test
    {{- include "opensearch-cluster-local.labels" . | nindent 4 }}
data:
  run.sh: |-

    #!/usr/bin/env bats

    load "/usr/lib/bats/bats-detik/utils"
    load "/usr/lib/bats/bats-detik/detik"

    DETIK_CLIENT_NAME="kubectl"

    @test "Verify successful deployment and running status of the {{ .Release.Name }}-operator pod" {
        verify "there is 1 deployment named '{{ .Release.Name }}-operator'"
        try "at most 4 times every 5s to get pods named '{{ .Release.Name }}-operator-[a-zA-Z0-9]{9,10}-[a-zA-Z0-9]{5}$' and verify that '.status.phase' is 'running'"
    }

    @test "Verify successful deployment of the {{ .Release.Name }}-operator service" {
        verify "there is 1 service named '^{{ .Release.Name }}-operator$'"
    }

    @test "Verify presence of OpenSearch cluster CRD" {
        verify "there is 1 customresourcedefinition named 'opensearchclusters.opensearch.opster.io'"
    }

    @test "Verify presence of OpenSearchCluster resource" {
        verify "there is at least 1 opensearchcluster in any namespace"
    }

    @test "Verify presence of OpenSearchIndexTemplate resource" {
        verify "there is at least 1 opensearchindextemplate in any namespace"
    }

    @test "Verify presence of OpenSearchRole resource" {
        verify "there is at least 1 opensearchrole in any namespace"
    }

    @test "Verify presence of OpenSearchUser resource" {
        verify "there is at least 1 opensearchuser in any namespace"
    }

    @test "Verify presence of OpenSearchUserRoleBinding resource" {
        verify "there is at least 1 opensearchuserrolebinding in any namespace"
    }

    @test "Verify OpenSearch client service exists" {
        verify "there is 1 service named 'opensearch-client-external'"
    }
{{- end -}}
