{{- if .Values.certManager.enable }}
# SPDX-FileCopyrightText: 2024 SAP SE or an SAP affiliate company and Greenhouse contributors
# SPDX-License-Identifier: Apache-2.0
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: opensearch-siem-ca-cert
  labels:
    {{- include "opensearch.labels" . | nindent 4 }}
spec:
  isCA: true
  commonName: siem-opensearch-ca
  duration: {{ .Values.certManager.defaults.durations.ca }}
  issuerRef:
{{ toYaml .Values.certManager.issuer.selfSigned | indent 4 }}
  privateKey:
{{ toYaml .Values.certManager.defaults.privateKey | indent 4 }}
  secretName: opensearch-siem-ca-cert
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: opensearch-siem-transport-cert
  labels:
    {{- include "opensearch.labels" . | nindent 4 }}
spec:
  commonName: siem-opensearch-transport
  duration: {{ .Values.certManager.defaults.durations.leaf }}
  issuerRef:
{{ toYaml .Values.certManager.issuer.ca | indent 4 }}
  privateKey:
{{ toYaml .Values.certManager.defaults.privateKey | indent 4 }}
  secretName: opensearch-siem-transport-cert
  dnsNames:
    - siem-opensearch
    - siem-opensearch-discovery
    - {{ printf "siem-opensearch.%s" .Release.Namespace }}
    - {{ printf "siem-opensearch.%s.svc" .Release.Namespace }}
    - {{ printf "siem-opensearch.%s.svc.cluster.local" .Release.Namespace }}
  usages:
{{ toYaml .Values.certManager.defaults.usages | indent 4 }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: opensearch-siem-admin-cert
  labels:
    {{- include "opensearch.labels" . | nindent 4 }}
spec:
  commonName: siem-admin
  duration: {{ .Values.certManager.defaults.durations.leaf }}
  issuerRef:
{{ toYaml .Values.certManager.issuer.ca | indent 4 }}
  privateKey:
{{ toYaml .Values.certManager.defaults.privateKey | indent 4 }}
  secretName: opensearch-siem-admin-cert
  usages:
{{ toYaml .Values.certManager.defaults.usages | indent 4 }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: opensearch-siem-http-cert
  labels:
    {{- include "opensearch.labels" . | nindent 4 }}
spec:
  duration: {{ .Values.certManager.defaults.durations.leaf }}
  issuerRef:
{{ toYaml .Values.certManager.issuer.ca | indent 4 }}
  privateKey:
{{ toYaml .Values.certManager.defaults.privateKey | indent 4 }}
  secretName: opensearch-siem-http-cert
  dnsNames:
    - siem-opensearch
    - {{ printf "siem-opensearch.%s" .Release.Namespace }}
    - {{ printf "siem-opensearch.%s.svc" .Release.Namespace }}
    - {{ printf "siem-opensearch.%s.svc.cluster.local" .Release.Namespace }}
  usages:
{{ toYaml .Values.certManager.defaults.usages | indent 4 }}

{{- if .Values.siem.cluster.ingress.opensearch.enabled }}
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: opensearch-siem-http-cert-external
  labels:
    {{- include "opensearch.labels" . | nindent 4 }}
spec:
  duration: {{ .Values.certManager.defaults.durations.leaf }}
  issuerRef:
{{ toYaml .Values.certManager.issuer.digicert | indent 4 }}
  privateKey:
{{ toYaml .Values.certManager.defaults.privateKey | indent 4 }}
  secretName: opensearch-siem-http-cert-external
  dnsNames:
{{ toYaml .Values.certManager.httpDnsNames | indent 4 }}
  usages:
{{ toYaml .Values.certManager.defaults.usages | indent 4 }}
{{- end }}
{{- end }}
