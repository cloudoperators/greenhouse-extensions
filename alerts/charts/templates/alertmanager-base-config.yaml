{{ if and .Values.alerts.alertmanagerConfig.slack.channel .Values.alerts.alertmanagerConfig.slack.webhookURL }}
apiVersion: monitoring.coreos.com/v1alpha1
kind: AlertmanagerConfig
metadata:
  name: {{ include "kube-prometheus-stack.fullname" . }}-alertmanager
  labels:
    pluginconfig: "{{ $.Release.Name }}"
{{- include "kube-prometheus-stack.labels" . | indent 4 }}
spec:
  route:
    receiver: slack
    continue: false
    matchers:
      - name: alertname
        matchType: "!~"
        value: "Watchdog|InfoInhibitor"
      - name: organization
        matchType: "="
        value: {{ $.Release.Namespace | quote }}
  receivers:
    - name: slack
      slackConfigs:
        - channel: {{ .Values.alerts.alertmanagerConfig.slack.channel }}
          apiURL:
            key: slack-webhook-url
            name: {{ $.Release.Name }}-slack-webhook
          username: {{ .Values.alerts.alertmanagerConfig.slack.username }}
          title: {{"'{{template \"slack.greenhouse.title\" . }}'"}}
          titleLink: {{"'{{template \"slack.greenhouse.titlelink\" . }}'"}}
          text: {{"'{{template \"slack.greenhouse.text\" . }}'"}}
          pretext: {{"'{{template \"slack.greenhouse.pretext\" . }}'"}}
          iconEmoji: {{"'{{template \"slack.greenhouse.iconemoji\" . }}'"}}
          callbackId: "alertmanager"
          color: {{`'{{template "slack.greenhouse.color" . }}'`}}
          sendResolved: true
{{- end }}
