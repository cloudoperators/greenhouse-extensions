name: "Helm Docs Check"

on:
  pull_request:
    paths:
      - "**/*/values.yaml"
      - "**/*/*/values.yaml"

jobs:
  helm-docs-check:
    runs-on: [default]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up go environment
        uses: actions/setup-go@v5
        with:
          go-version: 1.22.0

      - name: Detect Changed Plugins
        id: changed-plugins
        run: |
          echo "Detecting changed values.yaml files..."
          changed_values=$(git diff --name-only origin/${{ github.event.repository.default_branch }} HEAD | grep "/values.yaml" || true)

          if [[ -z "$changed_values" ]]; then
            echo "No values.yaml changes detected."
            echo "changed_plugins=" >> "$GITHUB_OUTPUT"
            echo "filtered_plugins=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          changed_plugins=$(echo "$changed_values" | cut -d'/' -f1 | sort -u | tr '\n' ' ')
          filtered_plugins=""
          for plugin in $changed_plugins; do
            if [[ -f "$plugin/README.md.gotmpl" ]]; then
              filtered_plugins+="$plugin "
            fi
          done

          echo "Plugins with changed values.yaml and README.md.gotmpl: $filtered_plugins"
          echo "changed_plugins=$filtered_plugins" >> "$GITHUB_OUTPUT"
          echo "filtered_plugins=$filtered_plugins" >> "$GITHUB_OUTPUT"

      - name: Generate README.md using Helm Docs
        id: generate-readme
        run: |
          filtered_plugins="${{ steps.changed-plugins.outputs.filtered_plugins }}"
          if [[ -z "$filtered_plugins" ]]; then
            echo "No plugins need README generation."
            exit 0
          fi

          echo "Generating README.md for modified plugins..."
          for plugin in $filtered_plugins; do
            echo "Processing $plugin..."
            make generate-readme PLUGIN=$plugin
          done
          echo "README.md generation completed."

      - name: Check for README.md Changes
        id: check-readme
        run: |
          filtered_plugins="${{ steps.changed-plugins.outputs.filtered_plugins }}"
          if [[ -z "$filtered_plugins" ]]; then
            echo "No plugins to check for README changes."
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Checking if README.md files were modified..."
          needs_update=false
          for plugin in $filtered_plugins; do
            if ! git diff --quiet origin/${{ github.event.repository.default_branch }} -- "$plugin/README.md"; then
              echo "README.md for $plugin is outdated."
              needs_update=true
            fi
          done

          echo "needs_update=$needs_update" >> "$GITHUB_OUTPUT"

      - name: Fail if README.md is outdated
        if: steps.check-readme.outputs.needs_update == 'true'
        run: |
          filtered_plugins="${{ steps.changed-plugins.outputs.filtered_plugins }}"
          echo "README.md is outdated. Please run the following command for each affected plugin and update the PR:"
          for plugin in $filtered_plugins; do
            if [[ -n "$plugin" ]]; then
              echo "make generate-readme PLUGIN=$plugin"
            fi
          done
          exit 1

      - name: Post PR comment if README is outdated
        if: failure() && steps.check-readme.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            const filteredPlugins = "${{ steps.changed-plugins.outputs.filtered_plugins }}".split(" ").filter(plugin => plugin.trim() !== "");
            if (filteredPlugins.length > 0) {
              const pluginCommands = filteredPlugins
                .map(plugin => `make generate-readme PLUGIN=${plugin}`)
                .join("\n");
              const comment = `âš ï¸ **Action Required: Update Your README.md!** ğŸ“œğŸš€\n\nğŸ“Œ The README.md for one or more plugins is outdated due to changes in *values.yaml*. Please update it by running the following command(s):\n\n\`\`\`sh\n${pluginCommands}\n\`\`\`\n\nâœ… Once you've done that, commit the updated README and push it to this PR.\n\nğŸ’¡ *Keeping documentation up to date ensures clarity and consistency for everyone!* ğŸ› ï¸âœ¨`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
