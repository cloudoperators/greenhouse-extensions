name: "Helm Docs Check"

on:
  pull_request:
    paths:
      - "**/*/values.yaml"
      - "**/*/*/values.yaml"

jobs:
  helm-docs-check:
    runs-on: [default]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up go environment
        uses: actions/setup-go@v5
        with:
          go-version: 1.22.0

      - name: Set up environment
        run: |
          echo "Setting up environment..."
          sudo apt-get update && sudo apt-get install -y make

      - name: Detect Changed Plugins
        id: changed-plugins
        run: |
          echo "Detecting changed values.yaml files..."
          changed_values=$(git diff --name-only origin/${{ github.event.repository.default_branch }} HEAD | grep "/values.yaml" || true)

          if [[ -z "$changed_values" ]]; then
            echo "No values.yaml changes detected."
            echo "changed_plugins=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Extract plugin names from the changed values.yaml paths 
          changed_plugins=$(echo "$changed_values" | cut -d'/' -f1 | sort -u | tr '\n' ' ')
          echo "Plugins with changed values.yaml: $changed_plugins"
          echo "changed_plugins=$changed_plugins" >> "$GITHUB_OUTPUT"

      - name: Generate README.md using Helm Docs
        id: generate-readme
        run: |
          changed_plugins="${{ steps.changed-plugins.outputs.changed_plugins }}"
          if [[ -z "$changed_plugins" ]]; then
            echo "No plugins need README generation."
            exit 0
          fi

          echo "Generating README.md for modified plugins with template..."
          for plugin in $changed_plugins; do
            if [[ -f "$plugin/README.md.gotmpl" ]]; then
              echo "Processing $plugin..."
              make generate-readme PLUGIN=$plugin
            else
              echo "Skipping $plugin - README.md.gotmpl not found."
            fi
          done
          echo "README.md generation completed."

      - name: Check for README.md Changes
        id: check-readme
        run: |
          changed_plugins="${{ steps.changed-plugins.outputs.changed_plugins }}"
          if [[ -z "$changed_plugins" ]]; then
            echo "No plugins to check for README changes."
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          echo "Checking if README.md files were modified..."
          modified_readmes=$(git diff --name-only | grep README.md || true  
          if [[ -n "$modified_readmes" ]]; then
            echo "Modified README.md files: $modified_readmes"
            updated_plugins=$(echo "$modified_readmes" | awk -F'/' '{print $1}' | sort -u | tr '\n' ' ')
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
            echo "updated_plugins=${updated_plugins}" >> "$GITHUB_OUTPUT"
          else
            echo "No README.md changes detected."
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
          fi
