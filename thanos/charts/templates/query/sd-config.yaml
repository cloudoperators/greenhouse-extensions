apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "release.name" . }}-sd-config
data:
  endpoint-targets.yaml: |-
    - targets:
{{- if .Values.thanos.query.standalone -}}
{{- range $index, $plugin := (lookup "greenhouse.sap/v1alpha1" "Plugin" "" "").items }}
    {{- if eq (index $plugin.metadata.labels "greenhouse.sap/plugindefinition") "thanos" }}
      {{- with $plugin.status.exposedServices }}
      {{- range $key, $exposedService := $plugin.status.exposedServices }}
      - {{ $key }}
      {{- end -}}
      {{- end }}
    {{- end }}
{{- end }}
{{- end -}}
{{- if not .Values.thanos.query.standalone }}
      - prometheus-operated:10901
      - {{ include "release.name" . }}-store:{{ default "10901" .Values.thanos.grpcAddress }}
{{- end -}}