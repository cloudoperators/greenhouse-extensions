{{- if .Values.testFramework.enabled -}}
# SPDX-FileCopyrightText: 2025 SAP SE or an SAP affiliate company and Greenhouse contributors
# SPDX-License-Identifier: Apache-2.0
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-test
  namespace: {{ .Release.Namespace }}
  labels:
    type: integration-test
    {{- include "kafka.labels" . | nindent 4 }}
data:
  run.sh: |-

    #!/usr/bin/env bats

    load "/usr/lib/bats/bats-detik/utils"
    load "/usr/lib/bats/bats-detik/detik"

    DETIK_CLIENT_NAME="kubectl"
    DETIK_CLIENT_NAMESPACE="{{ .Release.Namespace }}"

    @test "Verify successful deployment and running status of the operator pod" {
        try "at most 10 times every 5s to get pods named 'strimzi-cluster-operator-[a-z0-9]+-[a-z0-9]+' and verify that '.status.phase' is 'Running'"
    }

    @test "Verify presence of Kafka resource" {
      [ "$(kubectl get kafkas.kafka.strimzi.io -n {{ .Release.Namespace }} --no-headers | wc -l)" -ge 1 ]
    }

    @test "Verify presence of KafkaNodePool resource" {
      [ "$(kubectl get kafkanodepools.kafka.strimzi.io -n {{ .Release.Namespace }} --no-headers | wc -l)" -ge 1 ]
    }

    @test "Verify Kafka broker pod is running" {
        try "at most 30 times every 10s to get pods named '{{ .Values.kafka.name }}-controllers-' and verify that '.status.phase' is 'Running'"
    }

    @test "Verify Entity Operator pod is running" {
        try "at most 20 times every 10s to get pods named '{{ .Values.kafka.name }}-entity-operator-' and verify that '.status.phase' is 'Running'"
    }

    @test "Verify Kafka bootstrap service exists" {
        try "at most 5 times every 5s to get services named '{{ .Values.kafka.name }}-kafka-bootstrap' and verify that '.metadata.name' is '{{ .Values.kafka.name }}-kafka-bootstrap'"
    }

    @test "Verify Kafka cluster status is Ready" {
        try "at most 30 times every 10s to get kafkas.kafka.strimzi.io named '{{ .Values.kafka.name }}' and verify that '.status.conditions[?(@.type==\"Ready\")].status' is 'True'"
    }

{{- end -}}
